define([], function() {
  var pilot={len:0,tLen:0,_speed:15,_xs:[],_ys:[],_zs:[],_ls:[],_ts:[],_xks:[],_yks:[],_zks:[],_lks:[],_x2:0,_y2:0,_z2:0,_CSPL:{_gaussJ:{solve:function(a,b){for(var c=a.length,d=0;c>d;d++){for(var e=0,f=Number.NEGATIVE_INFINITY,g=d;c>g;g++)a[g][d]>f&&(e=g,f=a[g][d]);this.swapRows(a,d,e),0==a[e][g]&&console.log("matrix is singular!");for(var g=d+1;c>g;g++){for(var h=d+1;c+1>h;h++)a[g][h]=a[g][h]-a[d][h]*(a[g][d]/a[d][d]);a[g][d]=0}}for(var g=c-1;g>=0;g--){var i=a[g][c]/a[g][g];b[g]=i;for(var h=g-1;h>=0;h--)a[h][c]-=a[h][g]*i,a[h][g]=0}},zerosMat:function(a,b){for(var c=[],d=0;a>d;d++){c.push([]);for(var e=0;b>e;e++)c[d].push(0)}return c},printMat:function(a){for(var b=0;b<a.length;b++)console.log(a[b])},swapRows:function(a,b,c){var d=a[b];a[b]=a[c],a[c]=d}},getNaturalKs:function(a,b,c){for(var d=a.length-1,e=this._gaussJ.zerosMat(d+1,d+2),f=1;d>f;f++)e[f][f-1]=1/(a[f]-a[f-1]),e[f][f]=2*(1/(a[f]-a[f-1])+1/(a[f+1]-a[f])),e[f][f+1]=1/(a[f+1]-a[f]),e[f][d+1]=3*((b[f]-b[f-1])/((a[f]-a[f-1])*(a[f]-a[f-1]))+(b[f+1]-b[f])/((a[f+1]-a[f])*(a[f+1]-a[f])));e[0][0]=2/(a[1]-a[0]),e[0][1]=1/(a[1]-a[0]),e[0][d+1]=3*(b[1]-b[0])/((a[1]-a[0])*(a[1]-a[0])),e[d][d-1]=1/(a[d]-a[d-1]),e[d][d]=2/(a[d]-a[d-1]),e[d][d+1]=3*(b[d]-b[d-1])/((a[d]-a[d-1])*(a[d]-a[d-1])),this._gaussJ.solve(e,c)},evalSpline:function(a,b,c,d){for(var e=1;b[e]<a;)e++;var f=(a-b[e-1])/(b[e]-b[e-1]),g=d[e-1]*(b[e]-b[e-1])-(c[e]-c[e-1]),h=-d[e]*(b[e]-b[e-1])+(c[e]-c[e-1]),i=(1-f)*c[e-1]+f*c[e]+f*(1-f)*(g*(1-f)+h*f);return i}},_parsePath:function(){var a=0;this._xs=[this.g[0][0]],this._ys=[this.g[0][1]],this._zs=[this.g[0][2]],this._ls=[80],this._ts=[0];for(var b=1;b<this.g.length;b++){var c=Math.sqrt(Math.pow(this.g[b-1][0]-this.g[b][0],2)+Math.pow(this.g[b-1][1]-this.g[b][1],2)+Math.pow(this.g[b-1][2]-this.g[b][2],2));this._xs[b]=this.g[b][0],this._ys[b]=this.g[b][1],this._zs[b]=this.g[b][2],this._ts[b]=this._ts[b-1]+3600*c/this._speed,a+=c;var d=Math.sqrt(Math.pow(this.g[b-1][0]-this.g[b][0],2)+Math.pow(this.g[b-1][1]-this.g[b][1],2)),e=this.g[b][2]-this.g[b-1][2];this._ls[b]=Math.abs(e)<d?80:e>0?90:70}this.len=a,this.tLen=this._ts[this._ts.length-1],this._xks=[],this._CSPL.getNaturalKs(this._ts,this._xs,this._xks),this._yks=[],this._CSPL.getNaturalKs(this._ts,this._ys,this._yks),this._zks=[],this._CSPL.getNaturalKs(this._ts,this._zs,this._zks),this._lks=[],this._CSPL.getNaturalKs(this._ts,this._ls,this._lks)},setFlightPath:function(a,b){if(this.g=a,this._parsePath(),!b){for(var c=[],d=25,e=1e3*d/this._speed,f=0;f<this.tLen;)c.push([x2=this._CSPL.evalSpline(f,this._ts,this._xs,this._xks),y2=this._CSPL.evalSpline(f,this._ts,this._ys,this._yks),z2=this._CSPL.evalSpline(f,this._ts,this._zs,this._zks)]),f+=e;f!==this.tLen&&(f=this.tLen,c.push([x2=this._CSPL.evalSpline(f,this._ts,this._xs,this._xks),y2=this._CSPL.evalSpline(f,this._ts,this._ys,this._yks),z2=this._CSPL.evalSpline(f,this._ts,this._zs,this._zks)])),this.setFlightPath(c,!0)}},fly:function(a,b){if(!(0>a)){var c=this._x2?this._x2:b.position.x,d=this._y2?this._y2:b.position.y,f=(this._z2?this._z2:b.position.z,this._CSPL.evalSpline(a,this._ts,this._xs,this._xks)),g=this._CSPL.evalSpline(a,this._ts,this._ys,this._yks),h=this._CSPL.evalSpline(a,this._ts,this._zs,this._zks)+3.5;this._x2=f,this._y2=g,this._z2=h;var i=9,j=Math.sqrt(Math.pow(f-c,2)+Math.pow(g-d,2));if(j){var k=i*(c-f)/j+c,l=i*(d-g)/j+d;b.position.x=k,b.position.y=l}b.position.z=h;var m=g-d,n=f-c,o=180*Math.atan(m/n)/Math.PI;isNaN(o)||(b.heading=n>=0?90-o:270-o),b.tilt=this._CSPL.evalSpline(a,this._ts,this._ls,this._lks)}}};
  return pilot;
});
